<!DOCTYPE html>
<html>
  <head>
    <title>Experiment - Predict words in stories!</title>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> 

    <!-- LOAD FINNLAB SPECIFIC THINGS --> 
    <script src="https://rcweb.dartmouth.edu/~f003rjw/jspsych_experiments/utils/javascript_utils.js" type="text/javascript"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="https://unpkg.com/jspsych@7.2.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.1"></script>
    <link href="https://unpkg.com/jspsych@7.2.3/css/jspsych.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
  </body>

  <script>

    ///////////////////////////////////////////
    //////// LOAD EXPERIMENT PARAMETERS ///////
    ///////////////////////////////////////////

    // Use FinnLab helper script to load the information
    var experiment_information = getExperimentInformation();
    var current_experiment = experiment_information[0].current_experiment;

    var practice_fn = experiment_information[current_experiment].practice_info;
    var stimulus_fn = experiment_information[current_experiment].stimulus_info;

    var modality = experiment_information[current_experiment].stimulus_modality;
    
    // practice_fn = "https://rcweb.dartmouth.edu/~f003rjw/jspsych_experiments/experiments/isc_asynchrony_behavior/stimuli/presentation_orders/test/nwp_practice_trial/jspsych/practice_task-nwp_practice_trial.json"

    // stimulus_fn = "https://rcweb.dartmouth.edu/~f003rjw/jspsych_experiments/experiments/isc_asynchrony_behavior/stimuli/presentation_orders/test/black/jspsych/sub-00001_task-black.json"

    html_string = "https://rcweb.dartmouth.edu/~f003rjw/jspsych_experiments/experiments/"
    replace_string = "/dartfs/rc/lab/F/FinnLab/tommy/"

    var disqualified = false;

    ///////////////////////////////////////////
    /////// GLOBAL EXPERIMENT FUNCTIONS ///////
    ///////////////////////////////////////////

    var jsPsych = initJsPsych({
      // TLB NOTE - this allows us to see the collected data
      on_interaction_data_update: function(){
        setTextContainerOffset();
        setTextContainerPosition();
      },
      on_close: function(){ 
        alert("The experiment isn't finished. Are you sure you want to leave the page?");
      },
      on_finish: function() {
        saveNWPData();

        jsPsych.pluginAPI.setTimeout(function(){

          if (!disqualified){
            progressExperiment();
          }
        }, 5000);
      }
    });

    function saveNWPData(){

      saveExperimentData(
        jsPsych = jsPsych, 
        write_data_url = experiment_information[0].write_data_url, 
        output_path = pathJoin(parts=[
            experiment_information[0].output_path, 
            experiment_information[current_experiment].experiment_name,
            experiment_information[current_experiment].experiment_version,
            experiment_information[current_experiment].task_name,
            experiment_information[current_experiment].stimulus_modality,
            experiment_information[0].subject_id
            ]), 
        output_filename = [experiment_information[0].subject_id, '_next-word-prediction'].join(''),
       );
    }

    // Add URL vars and time start to the data
    addParticipantInformation(jsPsych);

    /////////////////////////////////////////////////////
    ///////////// INSTRUCTIONS FOR TASKS ////////////////
    /////////////////////////////////////////////////////

    var audio_instructions = [
      'Welcome to the experiment. Click next to advance the instructions.<br><br>',
      'In this experiment, you will listen to a recording of someone telling a story. <b>Please make sure to turn your volume on and be in a quiet location</b>.<br><br>',
      'On occasion, the story will stop and a blank space “_______” will appear. Please type the word that you believe is most likely coming next.<br><br>',
      'After you submit your response, you will hear the actual word spoken in the story and the story will continue. Don’t worry if you were wrong — we’re just interested in your best guess.<br><br>',
      'Please submit your response as quickly as possible — remember, we’re not concerned about accuracy, so go with your first instinct and take your best guess at predicting the next word.<br><br>',
      'Click next to do a practice trial!<br><br>'
      ];

    var text_instructions = [
      'Welcome to the experiment. Click next to advance the instructions.<br><br>',
      'In this experiment, you will read a story. The words of the story will be presented on the screen one by one. <b>Please make to be in a quiet location</b>.',
      'On occasion, the story will stop and a blank space “_______” will appear. Please type the word that you believe is most likely coming next.<br><br>',
      'After you submit your response, the actual word spoken in the story will appear in <span style="color: #2d9bc0">blue</span> and the story will continue. Don’t worry if you were wrong — we’re just interested in your best guess.<br><br>',
      'Please submit your response as quickly as possible — remember, we’re not concerned about accuracy, so go with your first instinct and take your best guess at predicting the next word.<br><br>',
      'Click next to do a practice trial!<br><br>'
      ];

    var audio_text_instructions = [
      'Welcome to the experiment. Click next to advance the instructions.<br><br>',
      'In this experiment, you will listen to a recording of someone telling a story. The words of the story will be presented on the screen as they are spoken outloud so <b>please make sure to turn your volume on and be in a quiet location</b>.<br><br>',
      'On occasion, the story will stop and a blank space “_______” will appear. Please type the word that you believe is most likely coming next.<br><br>',
      'After you submit your response, the actual word spoken in the story will appear in <span style="color: #2d9bc0">blue</span> and the story will continue. Don’t worry if you were wrong — we’re just interested in your best guess.<br><br>',
      'Please submit your response as quickly as possible — remember, we’re not concerned about accuracy, so go with your first instinct and take your best guess at predicting the next word.<br><br>',
      'Click next to do a practice trial!<br><br>'
      ];

    var post_practice_instructions = ['Great job! Now we will start the experiment. Press next to begin.'];

    var instructions_text;

    if (modality === 'text'){
      instructions_text = text_instructions;
    }
    else if (modality === 'audio'){
      instructions_text = audio_instructions;
    }
    else{
      instructions_text = audio_text_instructions
    }

    /////////////////////////////////////////////////////
    ///////////// STIMULUS INFO FUNCTIONS ///////////////
    /////////////////////////////////////////////////////

    function loadStimulusInfo(url){
      
      var stimulus_info; 

      $.ajax({
        url: url,
        dataType: 'json',
        type: 'get',
        cache: true,
        async: false,
        success: function (data) {
          // for each item (e.g., trial here) turn the word_info string into a json
          // and set equal to the variable
          data.forEach(item => item.word_info = JSON.parse(item.word_info));
          stimulus_info = data; // discard the transcript
        }
      });

      // Collect the filenames of each of the audio files
      stimulus_info.forEach(item => item.filename = item.filename.replace(replace_string, html_string))

      return stimulus_info
    }

    function getStimulusFilenames(stimulus_info){
      var all_filenames = [];
      stimulus_info.forEach(item => all_filenames.push(item.filename))

      return all_filenames
    }

    function addStimulusTrials(stimulus_info, experiment_phase, timeline){

      stimulus_info = stimulus_info.slice()

      // get all of the filenames for the current stimulus
      var all_filenames = getStimulusFilenames(stimulus_info)

      var preload = {
          type: jsPsychPreload,
          audio: all_filenames,
          show_progress_bar: true,
      }

      timeline.push(preload);

      for (var i = 0; i < stimulus_info.length; i++){

        last_trial = (stimulus_info.length == (i + 1))
        var trial = createTrial(stimulus_info[i], new Audio(), experiment_phase=experiment_phase, last_trial=last_trial);

        timeline.push(trial);
      }
    }

    function addInstructions(instructions_text, timeline){
      var instructions = {
          type: jsPsychInstructions,
          pages: instructions_text,
          show_clickable_nav: true
      }

      timeline.push(instructions);

    }

    /////////////////////////////////////////////////////
    //// STUFF FOR DISPLAYING THE TEXT OF A STIMULUS ////
    /////////////////////////////////////////////////////

    var container = '<div id="text_container"></div>';
    var parent_element = '.jspsych-display-element'
    var display_width = 0.5;

    function setTextContainerOffset(){
        $('#text_container').offset({
          "top": $(parent_element).offset().top + $(parent_element).height()*0.15,
          "left": $(parent_element).offset().left + $(parent_element).width()*((1-display_width)/2),
        });
    }

    function setTextContainerPosition(){
      $('#text_container').css({
        "margin": "0 auto",
        "width": String(display_width*100) + "%",
        "height": '15%',
        "overflow": "scroll",
        "overflow-y": "scroll",
        'text-align': 'left',
        'vertical-align': 'top',
      });
    }

    function updateScroll(){
      if($('#text_container').length){
        var element = document.getElementById("text_container");
        element.scrollTop = element.scrollHeight;
      }
    }

    function muteAudio(audio){
      audio.muted = true;
      console.log('Muted!');
    }

    function hideText(){
      if($('#text_container').length){
        $('#text_container').remove();
      }
    }

    function clearTextContainer(){
      display_text_stack = []

      if($('#text_container').length){
        $('#text_container').hide();
        $('#text_container').html('');
        $('#text_container').show();
      }
    }

    var n_items = 1000000; // tlb note --> should load this from a file
    var display_text_stack = [];
    var blank_string = '________';

    function updateTextContainer(array, new_string, wait_time=0, callback_func=null){

      // If we're over the number of items, remove the first items
      if (array.length > n_items){
        array.shift();
      }

      // Add the current string to the array
      array.push(new_string);

      // Start a timeout to insert the word and end the trial
      jsPsych.pluginAPI.setTimeout(function() {

        if($('#text_container').length){
          $('#text_container').html(array.join(''));
          updateScroll();
        }

        // Do this upon timeout
        if (callback_func){
          callback_func();
        }
      }, wait_time);
    }

    /////////////////////////////////////////////////////
    //////////////// AUDIO FUNCTIONS ////////////////////
    /////////////////////////////////////////////////////

    function addAudioStartListener(audio, word_info){

      audio.addEventListener("play", function (){

        for (var i = 0; i < word_info.length; i++) {

          var current_word = [word_info[i].Word_Written, word_info[i].Punctuation].join('');
          var onset = word_info[i].Norm_Onset;

          // This bit of code aliases the function so that the current word gets updated separately
          // from the loop
          jsPsych.pluginAPI.setTimeout(
            addWordToTextContainer(current_word), 
            1000*onset);
        }
      });
    }

    function addWordToTextContainer(word){
      /*
      Returns a function for a setTimeout to display a word
      */
      return function(){
        updateTextContainer(display_text_stack, word)
      }
    }

    function addAudioFinishListener(audio, last_trial){

      if (!last_trial){
        var post_audio_fx = function (){
          console.log("Here");

          updateTextContainer(
            array=display_text_stack.slice(),
            new_string=blank_string);

          $('#jspsych-survey-text-form').show().focus();
        };
      }
      else{
        var post_audio_fx = function () { 
          jsPsych.pluginAPI.setTimeout(jsPsych.finishTrial, 1000);
          clearTextContainer();
        };
      }

      audio.addEventListener("ended", post_audio_fx);
    }

    function setModality(audio){
      if (modality == 'text'){
        muteAudio(audio);
        console.log('Trial audio muted');
      }
      else if (modality == 'audio'){
        hideText();
        console.log('Trial text hidden');
      }
      else{
        console.log('Running text-audio experiment');
      }
    }

    function createTrial(stimulus_info, audio, experiment_phase, last_trial=false){

      // audio = new Audio();
      audio.src = stimulus_info.filename;
      audio.loop = false;

      addAudioStartListener(audio, stimulus_info.word_info);
      addAudioFinishListener(audio, last_trial);
      
      // audio.addEventListener('timeupdate', testDisplay(stimulus_info.word_info));

      var trial = {
        type: jsPsychSurveyText,
        questions: [
          {prompt: '', placeholder: 'Type your word', name: "response", required: true},
        ],
        on_load: function(){
          $('#jspsych-survey-text-form').hide();
           setModality(audio);
        },
        on_start: function(){
          audio.play();
        },
        on_finish: function(data){

          if (data.response != null){
            jsPsych.data.get().addToLast({
              response: data.response.response, // this extracts the response
              experiment_phase: experiment_phase,
              critical_word: stimulus_info.critical_word,
              word_index: stimulus_info.word_index,
              entropy_group: stimulus_info.entropy_group,
              accuracy_group: stimulus_info.accuracy_group,
            });
          }

          saveNWPData();

          if (!last_trial){
            jsPsych.pauseExperiment();

            // First update with a correct word string (don't need to wait)
            updateTextContainer(
              array = display_text_stack.slice(), // copy the current array
              new_string = ['<span id="correct_word">', stimulus_info.critical_word, '</span>'].join(''),
              wait_time = 0,
              callback_func = function () {
                $('#correct_word').css({
                  'color': '#2d9bc0',
                })});

            jsPsych.pluginAPI.setTimeout(jsPsych.resumeExperiment, 1000);
          }
        }, // add to array if not finished
      };

      return trial
    }

    ///////////////////////////////////////////
    //////////// MOTH QUESITONS ///////////////
    ///////////////////////////////////////////

    var moth_experience = {
      type: jsPsychSurveyMultiChoice,
      questions: [
         {prompt: "<b>Do you regularly listen to The Moth podcast?</b>", name: 'response',  options: ['Yes', 'Sometimes', 'No'], required: true}
      ],
     on_finish: function(data) {
        jsPsych.data.get().addToLast({
          response: data.response.response, // this extracts the response
          experiment_phase: 'experience-moth',
        });
      }
    }

    var story_experience = {
      type: jsPsychSurveyMultiChoice,
      questions: [
         {prompt: "<b>Have you heard this story before?</b>", name: 'response',  options: ['Yes', 'No', 'Unsure'], required: true}
      ],
     on_finish: function(data) {
        jsPsych.data.get().addToLast({
          response: data.response.response, // this extracts the response
          experiment_phase: 'experience-story',
        });
      }
    }

    ///////////////////////////////////////////
    //////// DEMOGRAPHICS QUESITONS ///////////
    ///////////////////////////////////////////

    var age = {
      type: jsPsychSurveyText,
      questions: [
         {prompt: "<b>Please enter your age in years</b>", name: 'response', required: true}
      ],
     on_finish: function(data) {
        jsPsych.data.get().addToLast({
          response: data.response.response, // this extracts the response
          experiment_phase: 'demographics-age',
        });
      }
    }

    var gender = {
      type: jsPsychSurveyMultiChoice,
      questions: [
          {prompt: "<b>How would you describe your gender?</b>", name: 'response', options: ['Male', 'Female', 'Non-Binary', 'Other', 'Do not wish to report'], 
          required:true},
        ],
      on_finish: function(data) {
        jsPsych.data.get().addToLast({
          response: data.response.response, // this extracts the response
          experiment_phase: 'demographics-gender',
        });
       }
     }

     var ethnicity = {
      type: jsPsychSurveyMultiChoice,
      questions: [
          {prompt: "<b>Are you of Hispanic or Latinx origin?</b>", name: 'response', options: ['Yes', 'No', 'Do not wish to report'], required:true},
        ],
      on_finish: function(data) {
        jsPsych.data.get().addToLast({
          response: data.response.response, // this extracts the response
          experiment_phase: 'demographics-ethnicity',
        });
       }
     }

    var race = {
      type: jsPsychSurveyMultiChoice,
      questions: [
          {prompt: "<b>Are you of Hispanic or Latinx origin?</b>", name: 'response', options: ['American Indian/Alaska Native', 'Asian', 
            'Native Hawaiian or Other Pacific Islander', 'Black or African American', 'White',
            'More than one race', 'Do not wish to report'], required: true},
        ],
      on_finish: function(data) {
        jsPsych.data.get().addToLast({
          response: data.response.response, // this extracts the response
          experiment_phase: 'demographics-race',
        });
       }
     }

     var feedback_text = {
       type: jsPsychSurveyText,
       questions: [
            {prompt: "<b>Do you have any final questions/comments about this study?</b>", name: 'response', rows: 5, required: false},
       ],
       on_finish: function(data) {
        jsPsych.data.get().addToLast({
          response: data.response.response, // this extracts the response
          experiment_phase: 'feedback',
        });
       }
     }

    ///////////////////////////////////////////
    ////////// CREATE THE TIMELINE ////////////
    ///////////////////////////////////////////

    var create_text_container = {
      type: jsPsychCallFunction,
      func: function(){
        $(parent_element).append(container);
        setTextContainerOffset();
        setTextContainerPosition();
        clearTextContainer();
      }
    }

    var fullscreen = {
      type: jsPsychFullscreen,
      fullscreen_mode: true
    }

    var screener = {
      type: jsPsychSurveyMultiChoice,
      questions: [
         {prompt: "<b>Do you regularly listen to The Moth podcast?</b>", name: 'response',  options: ['Yes', 'Sometimes', 'No'], required: true}
      ],
      on_finish: function(data) {

        jsPsych.data.get().addToLast({
          response: data.response.response, // this extracts the response
          experiment_phase: 'experience-moth',
        });

        if (data.response != 'No'){
          disqualified = true;
          jsPsych.endExperiment('Unfortunately, you do not qualify for our experiment! Please return the study on Prolific. \n\n<b>Any attempt to participate in this study will not receive credit.</b>');
        }
      }
    }

    var timeline = [create_text_container, fullscreen, screener];

    // add experiment instructions
    addInstructions(instructions_text, timeline);

    // practice trials
    practice_info = loadStimulusInfo(practice_fn)
    addStimulusTrials(practice_info, experiment_phase='practice', timeline=timeline)

    // add post-practice instructions
    addInstructions(post_practice_instructions, timeline);

    // add stimulus itself
    stimulus_info = loadStimulusInfo(stimulus_fn)
    addStimulusTrials(stimulus_info, experiment_phase='test', timeline=timeline)

    // add demographics/experience questions
    timeline.push(age, gender, ethnicity, race, story_experience, feedback_text);

    jsPsych.run(timeline);


  </script>
</html>